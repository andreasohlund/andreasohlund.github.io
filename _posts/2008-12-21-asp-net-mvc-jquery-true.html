---
layout: post
title: ">Asp.Net MVC + jQuery == true"
date: 2008-12-21 23:24:00.000000000 +01:00
categories:
- Asp.Net MVC
- jQuery
tags: []
status: publish
type: post
published: true
meta:
  blogger_blog: andreasohlund.blogspot.com
  blogger_permalink: "/2008/12/aspnet-mvc-jquery-true.html"
  dsq_thread_id: '299892658'
author:
  login: andreas.ohlund
  email: andreasohlund2@gmail.com
  display_name: Andreas Öhlund
  first_name: Andreas
  last_name: "Öhlund"
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>>
<p> I'm currently playing around with <a href="http://www.asp.net/mvc/">Asp.Net MVC</a> for a private little &quot;pet-project&quot; and I'm amazed how easy it is to make Ajax calls using <a href="http://jquery.com/">jQuery</a>! </p>
<p>I'm currently implementing the following story:</p>
<blockquote><p>As a <strong>user</strong> I want to search for <strong>available rooms</strong> in order to <strong>make a reservation</strong></p>
</blockquote>
<p>So my web page would look something like this: (obviously I'm not a web designer:)</p>
<p><a href="http://lh4.ggpht.com/_fqHEujhanB4/SU7CFoQjMjI/AAAAAAAAACU/kYQ3moY5fQE/s1600-h/image%5B14%5D.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="100" alt="image" src="assets/image_thumb%5B8%5D.png?imgmax=800" width="423" border="0" /></a> </p>
<p>And when the user clicks the search button an Ajax call will be made to the server which returns a list of available rooms. After the call the page will look like this:</p>
<p><a href="http://lh4.ggpht.com/_fqHEujhanB4/SU7CG_wCDaI/AAAAAAAAACc/khDQr6z0k4g/s1600-h/image%5B15%5D.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="122" alt="image" src="assets/image_thumb%5B9%5D.png?imgmax=800" width="442" border="0" /></a> </p>
<h4>jQuery Code</h4>
<p>The call is easily made with the jQuery <a href="http://docs.jquery.com/Ajax/jQuery.getJSON">$.getJSON - method</a>. Lets look at the JavaScript that is executed when the user clicks the &quot;search&quot; - button</p>
<p>
<div class="wlWriterSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E7:f001d30a-b344-4737-9796-9307e3c02fb0" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; width: 467px; padding-top: 0px">
<pre style="background-color:White;;overflow: auto;" />
<div><!--</p>
<p>Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/</p>
<p>--><span style="color: #000000;">$(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">#btnSearch</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).click(</span><span style="color: #0000FF;">function</span><span style="color: #000000;">() {<br />  </span><span style="color: #008000;">//</span><span style="color: #008000;">users room requirements</span><span style="color: #008000;"><br /></span><span style="color: #000000;">  </span><span style="color: #0000FF;">var</span><span style="color: #000000;"> roomRequriements </span><span style="color: #000000;">=</span><span style="color: #000000;"> {<br />  </span><span style="color: #000000;">&quot;</span><span style="color: #000000;">requirements.From</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">: $(</span><span style="color: #000000;">'</span><span style="color: #000000;">#fromDate</span><span style="color: #000000;">'</span><span style="color: #000000;">).attr(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">value</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">),<br />  </span><span style="color: #000000;">&quot;</span><span style="color: #000000;">requirements.To</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">: $(</span><span style="color: #000000;">'</span><span style="color: #000000;">#toDate</span><span style="color: #000000;">'</span><span style="color: #000000;">).attr(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">value</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">)<br />                }</p>
<p>                </span><span style="color: #008000;">//</span><span style="color: #008000;">clear table   </span><span style="color: #008000;"><br /></span><span style="color: #000000;">  $(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">#availableRooms tbody</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).html(</span><span style="color: #000000;">&quot;&quot;</span><span style="color: #000000;">);<br />  $.getJSON(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">/Booking/FindRooms</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">, roomRequriements, </span><span style="color: #0000FF;">function</span><span style="color: #000000;">(rooms) {<br />    $.each(rooms, </span><span style="color: #0000FF;">function</span><span style="color: #000000;">(i, room) {<br />    </span><span style="color: #0000FF;">var</span><span style="color: #000000;"> row </span><span style="color: #000000;">=</span><span style="color: #000000;"> $(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">&lt;tr/&gt;</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).attr(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">id</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">, room.Id);</p>
<p>    $(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">&lt;td/&gt;</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).html(room.Type).appendTo(row);<br />    $(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">&lt;td/&gt;</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).html(room.Description).appendTo(row);<br />    $(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">&lt;td/&gt;</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).html(room.Price).appendTo(row);<br />    $(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">&lt;td/&gt;</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).html($(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">&lt;input type='radio'/&gt;</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).attr(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">id</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">,</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">radio</span><span style="color: #000000;">&quot;</span><span style="color: #000000;"> </span><span style="color: #000000;">+</span><span style="color: #000000;"> i)).appendTo(row);</p>
<p>    $(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">#availableRooms tbody</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).append(row);<br />    });<br />  });</p>
<p>  $(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">#availableRooms</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">).trigger(</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">update</span><span style="color: #000000;">&quot;</span><span style="color: #000000;">);<br />  </span><span style="color: #0000FF;">return</span><span style="color: #000000;"> </span><span style="color: #0000FF;">false</span><span style="color: #000000;">;<br />});</span></div>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p></p></p>
<p>The first argument to getJSON is the URL that is going to get our call. If you are familiar with Asp.Net MVC you'll know that &quot;/Booking/FindRooms&quot; will be routed to the FindRooms - method on a class called BookingController. </p>
<p>The second is a map of key/value - pairs that will be sent as parameters to the server. The name of the keys is important because the entire map will be automatically mapped to an C# object by Asp.Net -MVC (more on this later).</p>
<p>The third is the callback that will execute when the call returns. As you see I'm iterating over some kind of magical object called &quot;rooms&quot; and for each &quot;room&quot; I'm adding a new row to my list of rooms that the user can choose from. </p>
<p><strong>Where did that magical &quot;rooms&quot; object come from?</strong></p>
<p>The &quot;rooms&quot; object is representing the returned data that our server sent in response to our call. In our case the server sent an IList&lt;Room&gt; serialized as <a href="http://www.json.org/">JSON</a> back to us. To explain this further we must look at the FindRooms method.</p>
<h4>The Asp.Net MVC Code</h4>
<p>So the user clicked the &quot;Search&quot;-button and a script in or browser took the entered dates and passed them as parameters to the URL /Booking/FindRooms. Asp.Net MVC received the call and routed it to a method on <strong>Booking</strong>Controller called <strong>FindRooms. </strong>Lets se how that method looks.</p>
<p> 
<div class="wlWriterSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E7:e99b530d-6040-4723-857e-47af1cb74a9a" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; padding-top: 0px">
<pre style="background-color:White;;overflow: auto;" />
<div><!--</p>
<p>Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/</p>
<p>--><span style="color: #0000FF;">public</span><span style="color: #000000;"> ActionResult FindRooms(RoomRequirements requirements)<br />{<br />    </span><span style="color: #0000FF;">return</span><span style="color: #000000;"> Json(</span><span style="color: #0000FF;">new</span><span style="color: #000000;"> List</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Room</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"><br />                    {<br />                        </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> Room<br />                            {<br />                                Id </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">1</span><span style="color: #000000;">,<br />                                Type</span><span style="color: #000000;">=</span><span style="color: #800000;">&quot;</span><span style="color: #800000;">Single</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">,<br />                                Description</span><span style="color: #000000;">=</span><span style="color: #800000;">&quot;</span><span style="color: #800000;">201</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">,<br />                                Price </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">1100.0</span><span style="color: #000000;"><br />                            },<br />                        </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> Room<br />                            {<br />                                Id </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">2</span><span style="color: #000000;">,<br />                                Type</span><span style="color: #000000;">=</span><span style="color: #800000;">&quot;</span><span style="color: #800000;">Single</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">,<br />                                Description</span><span style="color: #000000;">=</span><span style="color: #800000;">&quot;</span><span style="color: #800000;">301</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">,<br />                                Price </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">1000.0</span><span style="color: #000000;"><br />                            }<br />                    });<br />}</span></div>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p></p>
<p>Is that all??</p>
<p>Yes, and that's why I love Asp.Net MVC! ( you can write soooo clean code and the support for TDD is amazing!)</p>
<p>Remember those strange keys in the map that was sent as parameters? (requirements.From,requirements.To)</p>
<p>By using those keys Asp.Net MVC figured out how to deserialize that into the required &quot;requirements&quot;-parameter that our FindRooms -method expects. (&quot;RoomRequirements&quot; has two properties &quot;To&quot; and &quot;From&quot;). This means that we can keep our C#-code clean from &quot;magic&quot;-strings and let Asp.Net MVC get the parameters out of the request in a strongly typed manner. This is achieved be something behind the scenes called ModelBinders more on that <a href="http://www.singingeels.com/Articles/Model_Binders_in_ASPNET_MVC.aspx">here</a>. </p>
<p>Data is returned back to the caller serialized in JSON by the Json method of the Controller (the MVC base-class for all controllers). </p>
<p>Ok, a list of Room-objects was sent back to the client in JSON-format. Can that explain those magical &quot;rooms&quot; and &quot;room&quot;-objects?</p>
<p>It sure can!! As you would guess the method get<strong>JSON</strong> is expecting JSON formatted data back from the call to the server. When this happens jQuery automatically deserialize's the data to corresponding Javascript objects. So &quot;rooms&quot; was serialized to a list of &quot;room&quot;-objects. We iterated the list using jQuery's $each -function and created our row using room.Type, room.Name etc.</p>
<h4>Conclusion </h4>
<p>jQuery and Asp.Net MVC helps us to write powerful and clean code with just a few lines. And as a bonus it helps us to keep our &quot;magical - strings&quot; usage low.</p>
<p><em><strong>Hey, what about all that TDD - stuff you force us to do at work. Don't you do it on your hobby projects?</strong></em></p>
<p>Of course I used TDD for this. (Yes, I should use QUnit to TDD the JavaScript, I'll do that next time , promise! :)</p>
<p>Lets see how we can test our controller action with just a few lines of test code:</p>
<div class="wlWriterSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E7:33ebefc1-7f6e-48a3-a580-f6f2c2adae1f" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; padding-top: 0px">
<pre style="background-color:White;;overflow: auto;" />
<div><!--</p>
<p>Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/</p>
<p>--><span style="color: #000000;">[Test]<br /></span><span style="color: #0000FF;">public</span><span style="color: #000000;"> </span><span style="color: #0000FF;">void</span><span style="color: #000000;"> Find_avaliable_rooms()<br />{<br />    var controller </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> BookingController();<br />    DateTime to </span><span style="color: #000000;">=</span><span style="color: #000000;"> DateTime.Today;<br />    DateTime from </span><span style="color: #000000;">=</span><span style="color: #000000;"> DateTime.Today.AddDays(</span><span style="color: #800080;">1</span><span style="color: #000000;">);</p>
<p>    var model </span><span style="color: #000000;">=</span><span style="color: #000000;"> controller.FindRooms(</span><span style="color: #0000FF;">new</span><span style="color: #000000;"> RoomRequirements {From </span><span style="color: #000000;">=</span><span style="color: #000000;"> from, To </span><span style="color: #000000;">=</span><span style="color: #000000;"> to})<br />        .AssertResultIs</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">JsonResult</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">()<br />        .AssertPayloadIs</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">IList</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Room</span><span style="color: #000000;">&gt;&gt;</span><span style="color: #000000;">();</p>
<p>    Assert.That(model.Count, Is.EqualTo(</span><span style="color: #800080;">2</span><span style="color: #000000;">));<br />    Assert.That(model[</span><span style="color: #800080;">0</span><span style="color: #000000;">].Id, Is.EqualTo(</span><span style="color: #800080;">1</span><span style="color: #000000;">));<br />    Assert.That(model[</span><span style="color: #800080;">0</span><span style="color: #000000;">].Type, Is.EqualTo(</span><span style="color: #800000;">&quot;</span><span style="color: #800000;">Single</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">));<br />    Assert.That(model[</span><span style="color: #800080;">0</span><span style="color: #000000;">].Description, Is.EqualTo(</span><span style="color: #800000;">&quot;</span><span style="color: #800000;">201</span><span style="color: #800000;">&quot;</span><span style="color: #000000;">));<br />    Assert.That(model[</span><span style="color: #800080;">0</span><span style="color: #000000;">].Price, Is.EqualTo(</span><span style="color: #800080;">1100.0</span><span style="color: #000000;">));</p>
<p>}<br /></span></div>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Asp.Net MVC is really easy to unit test. In the code above I just create my controller. Invoke the &quot;FindRooms&quot; - method and make sure it return a JsonResult in which the payload is a list of rooms.</p>
<p>Note: AssertResultIs is a method from <a href="http://www.codeplex.com/MVCContrib/Wiki/View.aspx?title=TestHelper&amp;referringTitle=Documentation">MVCContribs TestHelpers</a> and AssertPayloadIs is one of my own helpers.</p>
<p>Phew, long post, must sleep now....</p>
